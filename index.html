<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset m·∫≠t kh·∫©u ‚Äî 3 b∆∞·ªõc</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: "Nunito", sans-serif;
      background: linear-gradient(180deg, #eef3ff 0%, #f5f7fb 100%);
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-6 text-[#243048]">
  <div class="w-full max-w-2xl bg-white/90 rounded-3xl shadow-xl p-7 backdrop-blur">
    <!-- Timeline -->
    <div class="p-5 rounded-2xl bg-gradient-to-r from-indigo-50 to-emerald-50 mb-6 relative shadow">
      <div
        class="absolute top-11 transform -translate-y-1/2 left-6 right-6 h-1 bg-gradient-to-r from-indigo-100 to-emerald-100 rounded-full">
      </div>
      <div class="flex justify-between relative z-10">
        <!-- Step 1 -->
        <div class="flex flex-col items-center text-center flex-1" id="timeline-step-1">
          <div
            class="w-11 h-11 rounded-full flex items-center justify-center font-bold text-white bg-gradient-to-br from-indigo-500 to-indigo-400 shadow-md text-sm step-circle">
            1
          </div>
          <h4 class="text-[13px] font-semibold mt-4">T√¨m ki·∫øm t√†i kho·∫£n</h4>
          <p class="text-[12px] text-gray-500 mt-1">Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i</p>
        </div>

        <!-- Step 2 -->
        <div class="flex flex-col items-center text-center flex-1" id="timeline-step-2">
          <div
            class="w-11 h-11 rounded-full flex items-center justify-center font-bold text-gray-400 bg-white border border-gray-200 shadow text-sm step-circle">
            2
          </div>
          <h4 class="text-[13px] font-semibold mt-4">Nh·∫≠p m√£ OTP</h4>
          <p class="text-[12px] text-gray-500 mt-1">X√°c th·ª±c m√£ g·ª≠i t·ªõi b·∫°n</p>
        </div>

        <!-- Step 3 -->
        <div class="flex flex-col items-center text-center flex-1" id="timeline-step-3">
          <div
            class="w-11 h-11 rounded-full flex items-center justify-center font-bold text-gray-400 bg-white border border-gray-200 shadow text-sm step-circle">
            3
          </div>
          <h4 class="text-[13px] font-semibold mt-4">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</h4>
          <p class="text-[12px] text-gray-500 mt-1">T·∫°o m·∫≠t kh·∫©u m·ªõi an to√†n</p>
        </div>
      </div>
    </div>

    <!-- Card Container -->
    <div id="card-container">
      <!-- Step 1 Card -->
      <div id="step-1-card"
        class="bg-white rounded-2xl bg-gradient-to-r from-indigo-50 to-emerald-50 p-8 shadow flex flex-col ">
        <div class="text-center mb-5">
          <h3 class="font-bold text-base text-gray-800 mb-2">T√¨m ki·∫øm t√†i kho·∫£n</h3>
          <p class="text-xs text-gray-500">Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√° tr√¨nh kh√¥i ph·ª•c</p>
        </div>

        <div class="flex flex-col gap-4 flex-1 justify-center">
          <div class="flex flex-col gap-3">
            <input id="identifier" type="tel" placeholder="V√≠ d·ª•: 0865123456"
              class="w-full px-5 py-4 rounded-xl border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 text-center text-[13px] font-medium transition-all duration-200 bg-white/80"
              maxlength="11" pattern="[0-9]{9,11}">
          </div>

          <div class="flex flex-col gap-2">
            <button id="search-btn" onclick="checkUserType()"
              class="w-full py-4 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-xl font-semibold shadow-lg hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] text-sm disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none">
              <span id="step1-loading" class="hidden">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg"
                  fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
              </span>
              üîç T√¨m ki·∫øm t√†i kho·∫£n
            </button>
          </div>

          <!-- Message hi·ªÉn th·ªã d∆∞·ªõi button -->
          <div id="step1-message" class="hidden"></div>
        </div>
      </div>

      <!-- Step 2 Card -->
      <div id="step-2-card"
        class="bg-white rounded-2xl bg-gradient-to-r from-indigo-50 to-emerald-50 p-8 shadow flex flex-col  hidden">
        <div class="text-center mb-5">
          <h3 class="font-bold text-md text-gray-800 mb-3">üî¢ Nh·∫≠p m√£ OTP</h3>
          <p class="text-[13px] text-gray-500">M·ªôt m√£ 6 ch·ªØ s·ªë ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n.<br>Vui
            l√≤ng
            nh·∫≠p m√£ trong v√≤ng 10 ph√∫t.</p>
        </div>

        <div class="flex flex-col gap-6 flex-1 justify-center">
          <div class="flex flex-col gap-4 items-center">
            <div class="flex justify-center gap-2" id="otp-inputs">
              <input
                class="w-11 h-11 text-center text-sm font-bold rounded-lg border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-200 otp-input"
                maxlength="1" placeholder="‚Ä¢">
              <input
                class="w-11 h-11 text-center text-sm font-bold rounded-lg border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-200 otp-input"
                maxlength="1" placeholder="‚Ä¢">
              <input
                class="w-11 h-11 text-center text-sm font-bold rounded-lg border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-200 otp-input"
                maxlength="1" placeholder="‚Ä¢">
              <input
                class="w-11 h-11 text-center text-sm font-bold rounded-lg border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-200 otp-input"
                maxlength="1" placeholder="‚Ä¢">
              <input
                class="w-11 h-11 text-center text-sm font-bold rounded-lg border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-200 otp-input"
                maxlength="1" placeholder="‚Ä¢">
              <input
                class="w-11 h-11 text-center text-sm font-bold rounded-lg border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-200 otp-input"
                maxlength="1" placeholder="‚Ä¢">
            </div>

            <div class="flex flex-col items-center gap-3 mt-3">
              <button id="resend-btn" onclick="resendOTP()"
                class="px-4 py-2 border border-indigo-200 text-indigo-600 rounded-lg text-sm font-semibold hover:bg-indigo-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white">
                <span id="resend-text">üì§ G·ª≠i l·∫°i m√£</span>
                <span id="resend-countdown" class="hidden"></span>
              </button>
            </div>

            <div id="step2-message" class="hidden text-center"></div>
          </div>

          <div class="flex gap-3">
            <button onclick="goBackToStep1()"
              class="flex-1 py-3 border border-indigo-200 text-indigo-600 rounded-xl font-medium hover:bg-indigo-50 transition-all duration-200 text-sm">
              ‚¨ÖÔ∏è Quay l·∫°i
            </button>
            <button onclick="verifyOTP()"
              class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-medium shadow-lg hover:bg-indigo-700 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] text-sm">
              <span id="step2-loading" class="hidden">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg"
                  fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
              </span>
              üîç X√°c th·ª±c
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3 Card -->
      <div id="step-3-card"
        class="bg-white rounded-2xl bg-gradient-to-r from-indigo-50 to-emerald-50 p-8 shadow flex flex-col  hidden">
        <div class="text-center mb-6">
          <h3 class="font-bold text-md text-gray-800 mb-2">üîê T·∫°o m·∫≠t kh·∫©u m·ªõi</h3>
          <p class="text-[13px] text-gray-500">T·∫°o m·∫≠t kh·∫©u m·ªõi m·∫°nh v√† an to√†n cho t√†i kho·∫£n c·ªßa b·∫°n.</p>
        </div>

        <div class="flex flex-col gap-5 flex-1 justify-center">
          <div class="flex flex-col gap-4">
            <div class="flex flex-col gap-2">
              <label for="new-password" class="text-sm font-semibold text-gray-700 text-center">üîë M·∫≠t kh·∫©u m·ªõi</label>
              <input id="new-password" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..."
                class="w-full px-5 py-4 rounded-xl border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 text-center text-sm font-medium transition-all duration-200 bg-white/80 text-[13px]">
            </div>

            <div class="flex flex-col gap-2">
              <label for="confirm-password" class="text-sm font-semibold text-gray-700 text-center">üîí X√°c nh·∫≠n m·∫≠t
                kh·∫©u</label>
              <input id="confirm-password" type="password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u..."
                class="w-full px-5 py-4 rounded-xl border-2 border-gray-200 shadow-sm outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 text-center text-sm font-medium transition-all duration-200 bg-white/80 text-[13px]">
            </div>

            <div id="step3-message" class="hidden text-center"></div>
          </div>

          <div class="mt-2">
            <button onclick="setNewPassword()"
              class="w-full py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-semibold shadow-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] text-sm">
              <span id="step3-loading" class="hidden">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg"
                  fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                  </path>
                </svg>
              </span>
              üéâ Ho√†n th√†nh ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u
            </button>
          </div>
        </div>
      </div>

      <!-- Success Card -->
      <div id="success-card"
        class="bg-white rounded-2xl bg-gradient-to-r from-green-50 to-emerald-50 p-8 shadow flex flex-col  hidden">
        <div class="text-center mb-6">
          <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h3 class="font-bold text-lg text-gray-800 mb-2">üéâ ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng!</h3>
          <p class="text-[14px] text-gray-600">M·∫≠t kh·∫©u c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng.<br>B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p b·∫±ng m·∫≠t kh·∫©u m·ªõi.</p>
        </div>

        <div class="flex flex-col gap-4">
          <div class="bg-white/60 rounded-xl p-4 border border-green-200">
            <div class="flex items-center justify-center gap-2 text-gray-700">
              <span class="text-sm font-medium">üì± T√†i kho·∫£n:</span>
              <span class="text-sm font-bold" id="success-phone-number"></span>
            </div>
          </div>

          <div class="mt-2">
            <button onclick="goToLogin()"
              class="w-full py-4 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-xl font-semibold shadow-lg hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] text-sm">
              üîë Quay l·∫°i trang ƒëƒÉng nh·∫≠p
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 2; // M·∫∑c ƒë·ªãnh b∆∞·ªõc 2
    let currentUser = null;
    let countdownTimer = null;
    let resendTimer = null; // Timer cho n√∫t g·ª≠i l·∫°i
    let appDomain = null;
    let foundUserId = null; // Th√™m bi·∫øn foundUserId nh∆∞ index.html

    // L·∫•y domain t·ª´ backend khi load trang
    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        appDomain = config.domain;
      } catch (error) {
        console.error('Failed to load config:', error);
        appDomain = 'https://coding.hoola.vn'; // fallback
      }
    }

    // L∆∞u tr·∫°ng th√°i v√†o sessionStorage
    function saveState() {
      sessionStorage.setItem('resetPasswordState', JSON.stringify({
        currentStep: currentStep,
        currentUser: currentUser
      }));
    }

    // Kh√¥i ph·ª•c tr·∫°ng th√°i t·ª´ sessionStorage
    function loadState() {
      // Ki·ªÉm tra xem c√≥ ph·∫£i l√† tab/window m·ªõi kh√¥ng
      const isNewTab = !sessionStorage.getItem('isExistingSession');

      if (isNewTab) {
        // Tab m·ªõi: Reset v·ªÅ b∆∞·ªõc 1
        currentStep = 1;
        currentUser = null;
        sessionStorage.removeItem('resetPasswordState');
        // ƒê√°nh d·∫•u session ƒë√£ t·ªìn t·∫°i
        sessionStorage.setItem('isExistingSession', 'true');
      } else {
        // Reload trang: Kh√¥i ph·ª•c tr·∫°ng th√°i
        const saved = sessionStorage.getItem('resetPasswordState');
        if (saved) {
          const state = JSON.parse(saved);
          currentStep = state.currentStep || 1;
          currentUser = state.currentUser;
          // Kh√¥i ph·ª•c foundUserId
          if (currentUser && currentUser._id) {
            foundUserId = currentUser._id;
          }
        }
      }
    }

    // Hi·ªÉn th·ªã b∆∞·ªõc ƒë∆∞·ª£c ch·ªçn
    function showStep(step) {
      currentStep = step;

      // ·∫®n t·∫•t c·∫£ cards
      document.getElementById('step-1-card').classList.add('hidden');
      document.getElementById('step-2-card').classList.add('hidden');
      document.getElementById('step-3-card').classList.add('hidden');
      document.getElementById('success-card').classList.add('hidden');

      // ·∫®n ho·∫∑c hi·ªán timeline
      const timelineElement = document.querySelector('.p-5.rounded-2xl.bg-gradient-to-r.from-indigo-50.to-emerald-50.mb-6.relative.shadow');
      
      if (step === 'success') {
        // ·∫®n timeline v√† hi·ªán card th√†nh c√¥ng
        timelineElement.classList.add('hidden');
        document.getElementById('success-card').classList.remove('hidden');
        return; // Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t timeline
      } else {
        // Hi·ªán timeline cho c√°c step th√¥ng th∆∞·ªùng
        timelineElement.classList.remove('hidden');
        // Hi·ªÉn th·ªã card t∆∞∆°ng ·ª©ng
        document.getElementById(`step-${step}-card`).classList.remove('hidden');
      }

      // Reset resend button khi v√†o b∆∞·ªõc 2
      if (step === 2) {
        const resendBtn = document.getElementById('resend-btn');
        const resendText = document.getElementById('resend-text');
        const resendCountdown = document.getElementById('resend-countdown');

        if (resendBtn) {
          resendBtn.disabled = false;
          resendText.classList.remove('hidden');
          resendCountdown.classList.add('hidden');
        }

        // Clear resend timer if exists
        if (resendTimer) {
          clearInterval(resendTimer);
          resendTimer = null;
        }
      }

      // C·∫≠p nh·∫≠t timeline
      updateTimeline(step);

      // L∆∞u tr·∫°ng th√°i
      saveState();
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i timeline
    function updateTimeline(activeStep) {
      for (let i = 1; i <= 3; i++) {
        const stepElement = document.querySelector(`#timeline-step-${i} .step-circle`);
        const stepContainer = document.getElementById(`timeline-step-${i}`);

        if (i === activeStep) {
          // B∆∞·ªõc hi·ªán t·∫°i - m√†u xanh d∆∞∆°ng
          stepElement.className = 'w-11 h-11 rounded-full flex items-center justify-center font-bold text-white bg-gradient-to-br from-indigo-500 to-indigo-400 shadow-md text-sm step-circle';
        } else if (i < activeStep) {
          // B∆∞·ªõc ƒë√£ ho√†n th√†nh - m√†u xanh l√°
          stepElement.className = 'w-11 h-11 rounded-full flex items-center justify-center font-bold text-white bg-gradient-to-br from-emerald-500 to-emerald-400 shadow-md text-sm step-circle';
        } else {
          // B∆∞·ªõc ch∆∞a th·ª±c hi·ªán - m√†u x√°m
          stepElement.className = 'w-11 h-11 rounded-full flex items-center justify-center font-bold text-gray-400 bg-white border border-gray-200 shadow text-sm step-circle';
        }
      }
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o
    function showMessage(elementId, message, type = 'info') {
      const messageEl = document.getElementById(elementId);
      let bgColor, textColor, borderColor;

      switch (type) {
        case 'success':
          bgColor = 'bg-green-50';
          textColor = 'text-green-700';
          borderColor = 'border-green-200';
          break;
        case 'error':
          bgColor = 'bg-red-50';
          textColor = 'text-red-700';
          borderColor = 'border-red-200';
          break;
        case 'warning':
          bgColor = 'bg-yellow-50';
          textColor = 'text-yellow-700';
          borderColor = 'border-yellow-200';
          break;
        default:
          bgColor = 'bg-blue-50';
          textColor = 'text-blue-700';
          borderColor = 'border-blue-200';
      }

      messageEl.innerHTML = `<div class="${bgColor} ${borderColor} border rounded-lg p-3 text-sm ${textColor}">${message}</div>`;
      messageEl.classList.remove('hidden');
    }

    // Ki·ªÉm tra lo·∫°i ng∆∞·ªùi d√πng (B∆∞·ªõc 1)
    async function checkUserType() {
      const identifier = document.getElementById('identifier').value.trim();
      const loadingEl = document.getElementById('step1-loading');
      const searchBtn = document.getElementById('search-btn');
      const inputEl = document.getElementById('identifier');

      if (!identifier) {
        showMessage('step1-message', '‚ùå Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!', 'error');
        return;
      }

      // Validate s·ªë ƒëi·ªán tho·∫°i (9-11 ch·ªØ s·ªë)
      if (!/^0\d{8,10}$/.test(identifier)) {
        showMessage('step1-message', '‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i t·ª´ 9-11 ch·ªØ s·ªë b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 0.', 'error');
        return;
      }

      // Disable button v√† hi·ªÉn th·ªã loading
      searchBtn.disabled = true;
      loadingEl.classList.remove('hidden');
      document.getElementById('step1-message').classList.add('hidden');

      // Th√™m hi·ªáu ·ª©ng loading cho input
      inputEl.style.background = 'linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)';
      inputEl.style.backgroundSize = '200% 100%';
      inputEl.style.animation = 'loading-shimmer 1.5s infinite';
      inputEl.disabled = true;

      // Th√™m CSS animation n·∫øu ch∆∞a c√≥
      if (!document.getElementById('loading-styles')) {
        const style = document.createElement('style');
        style.id = 'loading-styles';
        style.textContent = `
                    @keyframes loading-shimmer {
                        0% { background-position: 200% 0; }
                        100% { background-position: -200% 0; }
                    }
                `;
        document.head.appendChild(style);
      }

      try {
        // Delay 1.5s ƒë·ªÉ hi·ªáu ·ª©ng loading
        await new Promise(resolve => setTimeout(resolve, 1500));

        // Ch·ªâ truy·ªÅn s·ªë ƒëi·ªán tho·∫°i v√†o param username
        let queryParams = new URLSearchParams();
        queryParams.append('username', identifier);

        // G·ªçi API t√¨m ki·∫øm user v·ªõi GET method
        const response = await fetch(`/api/search-user?${queryParams.toString()}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        }); const data = await response.json();

        // Reset UI states
        loadingEl.classList.add('hidden');
        searchBtn.disabled = false;
        inputEl.disabled = false;
        inputEl.style.background = '';
        inputEl.style.backgroundSize = '';
        inputEl.style.animation = '';

        // Ki·ªÉm tra response
        if (data.respCode === '00' && data.user) {
          // T√¨m th·∫•y user th√†nh c√¥ng - chuy·ªÉn th·∫≥ng sang b∆∞·ªõc 2
          const user = data.user;

          currentUser = {
            type: 'phone',
            identifier: identifier,
            _id: user._id, // S·ª≠ d·ª•ng _id thay v√¨ userId
            userInfo: user
          };

          // L∆∞u foundUserId ƒë·ªÉ s·ª≠ d·ª•ng khi ƒë·ªïi m·∫≠t kh·∫©u
          foundUserId = user._id;

          // L∆∞u tr·∫°ng th√°i v√† chuy·ªÉn b∆∞·ªõc 2
          saveState();
          showStep(2);
          showMessage('step2-message', `üì± M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ${identifier}`, 'success');
          startCountdown();
        } else {
          // C√≥ l·ªói - hi·ªÉn th·ªã th√¥ng b√°o l·ªói d∆∞·ªõi button
          if (data.respCode === '01') {
            showMessage('step1-message',
              `‚ùå <strong>Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n</strong><br><br>
                            S·ªë ƒëi·ªán tho·∫°i <strong>"${identifier}"</strong> kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng.<br><br>
                            <strong>üí° H∆∞·ªõng d·∫´n:</strong><br>
                            ‚Ä¢ Ki·ªÉm tra l·∫°i s·ªë ƒëi·ªán tho·∫°i ƒë√£ nh·∫≠p<br>
                            ‚Ä¢ ƒê·∫£m b·∫£o s·ªë ƒëi·ªán tho·∫°i b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 0<br>
                            ‚Ä¢ Li√™n h·ªá h·ªó tr·ª£ n·∫øu v·∫´n g·∫∑p v·∫•n ƒë·ªÅ`, 'error');
          } else {
            showMessage('step1-message',
              `‚ùå <strong>L·ªói h·ªá th·ªëng</strong><br><br>
                            ${data.msg || 'C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm t√†i kho·∫£n.'}<br><br>
                            Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá h·ªó tr·ª£.`, 'error');
          }
        }

      } catch (error) {
        // Reset UI states
        loadingEl.classList.add('hidden');
        searchBtn.disabled = false;
        inputEl.disabled = false;
        inputEl.style.background = '';
        inputEl.style.backgroundSize = '';
        inputEl.style.animation = '';

        console.error('API Error:', error);

        showMessage('step1-message',
          `‚ùå <strong>L·ªói k·∫øt n·ªëi</strong><br><br>
                    Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng:<br>
                    ‚Ä¢ Ki·ªÉm tra k·∫øt n·ªëi internet<br>
                    ‚Ä¢ Th·ª≠ l·∫°i sau v√†i gi√¢y<br>
                    ‚Ä¢ Li√™n h·ªá h·ªó tr·ª£ n·∫øu v·∫•n ƒë·ªÅ v·∫´n ti·∫øp di·ªÖn<br><br>
                    <strong>Chi ti·∫øt l·ªói:</strong> ${error.message}`, 'error');
      }
    }

    // X√°c th·ª±c OTP (B∆∞·ªõc 2)
    async function verifyOTP() {
      const otpInputs = document.querySelectorAll('.otp-input');
      const loadingEl = document.getElementById('step2-loading');
      let otpCode = '';

      otpInputs.forEach(input => {
        otpCode += input.value;
      });

      if (otpCode.length !== 6) {
        showMessage('step2-message', '‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß 6 s·ªë OTP!', 'error');
        return;
      }

      if (!foundUserId) {
        showMessage('step2-message', '‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng!', 'error');
        return;
      }

      loadingEl.classList.remove('hidden');
      document.getElementById('step2-message').classList.add('hidden');

      try {
        const response = await fetch('/api/verify-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: foundUserId,
            otpCode: otpCode
          })
        });

        const data = await response.json();
        loadingEl.classList.add('hidden');

        if (data.respCode === '00') {
          // OTP ƒë√∫ng - chuy·ªÉn sang b∆∞·ªõc 3
          showStep(3);
          saveState();
        } else {
          // OTP sai
          let errorMessage = data.msg || 'M√£ OTP kh√¥ng h·ª£p l·ªá!';
          if (data.attemptsLeft > 0) {
            errorMessage += ` C√≤n ${data.attemptsLeft} l·∫ßn th·ª≠.`;
          }
          showMessage('step2-message', `‚ùå ${errorMessage}`, 'error');

          // Clear OTP inputs n·∫øu h·∫øt l∆∞·ª£t th·ª≠
          if (data.respCode === '03') {
            otpInputs.forEach(input => {
              input.value = '';
            });
          }
        }
      } catch (error) {
        loadingEl.classList.add('hidden');
        console.error('Verify OTP error:', error);
        showMessage('step2-message', '‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    }

    // Reset v·ªÅ b∆∞·ªõc 1 (cho button "Quay l·∫°i" ·ªü step 2)
    function goBackToStep1() {
      currentUser = null;
      sessionStorage.removeItem('resetPasswordState');

      // Clear timers
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      if (resendTimer) {
        clearInterval(resendTimer);
        resendTimer = null;
      }

      showStep(1);

      // Clear input
      document.getElementById('identifier').value = '';
      document.getElementById('step1-message').classList.add('hidden');
    }
    async function resendOTP() {
      if (!currentUser || !foundUserId) {
        showMessage('step2-message', '‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng!', 'error');
        return;
      }

      const resendBtn = document.getElementById('resend-btn');
      const resendText = document.getElementById('resend-text');
      const resendCountdown = document.getElementById('resend-countdown');

      // Disable button
      resendBtn.disabled = true;
      resendText.classList.add('hidden');
      resendCountdown.classList.remove('hidden');
      resendCountdown.textContent = 'üì§ ƒêang g·ª≠i...';

      try {
        const response = await fetch('/api/resend-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: foundUserId,
            phoneNumber: currentUser.identifier
          })
        });

        const data = await response.json();

        if (data.respCode === '00') {
          // G·ª≠i th√†nh c√¥ng
          showMessage('step2-message', `‚úÖ G·ª≠i l·∫°i OTP th√†nh c√¥ng ƒë·∫øn ${currentUser.identifier}`, 'success');

          // Clear OTP inputs
          document.querySelectorAll('.otp-input').forEach(input => {
            input.value = '';
          });

          // Restart countdown
          startCountdown();

          // Start resend timer (1 minute = 60 seconds)
          let resendTimeLeft = 60;
          resendCountdown.textContent = `‚è≥ G·ª≠i l·∫°i sau ${resendTimeLeft}s`;

          if (resendTimer) {
            clearInterval(resendTimer);
          }

          resendTimer = setInterval(() => {
            resendTimeLeft--;
            resendCountdown.textContent = `‚è≥ G·ª≠i l·∫°i sau ${resendTimeLeft}s`;

            if (resendTimeLeft <= 0) {
              clearInterval(resendTimer);
              resendBtn.disabled = false;
              resendText.classList.remove('hidden');
              resendCountdown.classList.add('hidden');
            }
          }, 1000);
        } else {
          // G·ª≠i th·∫•t b·∫°i
          showMessage('step2-message', `‚ùå ${data.msg || 'Kh√¥ng th·ªÉ g·ª≠i l·∫°i OTP'}`, 'error');

          // Reset button
          resendBtn.disabled = false;
          resendText.classList.remove('hidden');
          resendCountdown.classList.add('hidden');
        }
      } catch (error) {
        console.error('Resend OTP error:', error);
        showMessage('step2-message', '‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');

        // Reset button
        resendBtn.disabled = false;
        resendText.classList.remove('hidden');
        resendCountdown.classList.add('hidden');
      }
    }

    // ƒê·∫∑t m·∫≠t kh·∫©u m·ªõi (B∆∞·ªõc 3)
    async function setNewPassword() {
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const loadingEl = document.getElementById('step3-loading');

      if (!newPassword || !confirmPassword) {
        showMessage('step3-message', '‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin m·∫≠t kh·∫©u!', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage('step3-message', '‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!', 'error');
        return;
      }

      if (!foundUserId) {
        showMessage('step3-message', '‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng!', 'error');
        return;
      }

      loadingEl.classList.remove('hidden');
      document.getElementById('step3-message').classList.add('hidden');

      try {
        const response = await fetch('/api/set-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: foundUserId,
            newPassword: newPassword
          })
        });

        const data = await response.json();
        loadingEl.classList.add('hidden');

        if (response.ok && data.respCode === '00') {
          // ƒê·∫∑t m·∫≠t kh·∫©u th√†nh c√¥ng - hi·ªán card th√†nh c√¥ng
          
          // C·∫≠p nh·∫≠t s·ªë ƒëi·ªán tho·∫°i trong card th√†nh c√¥ng
          const successPhoneEl = document.getElementById('success-phone-number');
          if (successPhoneEl && currentUser) {
            successPhoneEl.textContent = currentUser.identifier;
          }
          
          // Chuy·ªÉn sang card th√†nh c√¥ng
          showStep('success');
          
        } else {
          let errorMessage = 'ƒê·∫∑t m·∫≠t kh·∫©u th·∫•t b·∫°i!';
          if (data.msg) {
            errorMessage = data.msg;
          } else if (data.error) {
            errorMessage = data.error;
          }
          showMessage('step3-message', `‚ùå ${errorMessage}`, 'error');
        }
      } catch (error) {
        loadingEl.classList.add('hidden');
        console.error('Set password error:', error);
        showMessage('step3-message', '‚ùå L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.', 'error');
      }
    }

    // Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p (m·ªü tab m·ªõi)
    function goToLogin() {
      const loginUrl = `${appDomain}/join/login`;
      window.open(loginUrl, '_blank');
    }

    // OTP input auto-focus
    function setupOTPInputs() {
      const otpInputs = document.querySelectorAll('.otp-input');

      otpInputs.forEach((input, index) => {
        input.addEventListener('input', function (e) {
          // Ch·ªâ cho ph√©p s·ªë
          this.value = this.value.replace(/\D/g, '');

          // Auto focus next input
          if (this.value.length === 1 && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        });

        input.addEventListener('keydown', function (e) {
          // Backspace focus previous input
          if (e.key === 'Backspace' && this.value === '' && index > 0) {
            otpInputs[index - 1].focus();
          }
        });
      });
    }

    // Countdown timer
    function startCountdown() {
      let timeLeft = 600; // 10 minutes in seconds
      const countdownEl = document.getElementById('countdown');

      if (countdownTimer) {
        clearInterval(countdownTimer);
      }

      countdownTimer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (timeLeft <= 0) {
          clearInterval(countdownTimer);
          countdownEl.textContent = '0:00';
          showMessage('step2-message', '‚è∞ M√£ OTP ƒë√£ h·∫øt h·∫°n! Vui l√≤ng g·ª≠i l·∫°i m√£ m·ªõi.', 'warning');
        }

        timeLeft--;
      }, 1000);
    }

    // Kh·ªüi t·∫°o
    document.addEventListener('DOMContentLoaded', function () {
      // L·∫•y config t·ª´ backend
      loadConfig();

      // Kh√¥i ph·ª•c tr·∫°ng th√°i t·ª´ sessionStorage
      loadState();

      // Hi·ªÉn th·ªã b∆∞·ªõc hi·ªán t·∫°i (m·∫∑c ƒë·ªãnh b∆∞·ªõc 1)
      showStep(currentStep);
      setupOTPInputs();

      // Setup phone number input validation
      const phoneInput = document.getElementById('identifier');
      phoneInput.addEventListener('input', function (e) {
        // Ch·ªâ cho ph√©p nh·∫≠p s·ªë
        this.value = this.value.replace(/[^0-9]/g, '');

        // Gi·ªõi h·∫°n ƒë·ªô d√†i t·ªëi ƒëa 11 k√Ω t·ª±
        if (this.value.length > 11) {
          this.value = this.value.slice(0, 11);
        }
      });

      phoneInput.addEventListener('keypress', function (e) {
        // Ch·ªâ cho ph√©p nh·∫≠p s·ªë v√† c√°c ph√≠m ƒëi·ªÅu khi·ªÉn
        const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        const controlKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter'];

        if (!allowedKeys.includes(e.key) && !controlKeys.includes(e.key)) {
          e.preventDefault();
        }
      });

      // Enter key support
      document.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          if (currentStep === 1) {
            checkUserType();
          } else if (currentStep === 2) {
            verifyOTP();
          } else if (currentStep === 3) {
            setNewPassword();
          }
        }
      });
    });
  </script>
</body>

</html>